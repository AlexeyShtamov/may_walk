<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–∞–π—Å–∫–∞—è –ø—Ä–æ–≥—É–ª–∫–∞ ‚Äî –º–∞—Ä—à—Ä—É—Ç—ã</title>
  <meta name="api-base-url" content="http://localhost:8080/api" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<div id="app">
  <header class="topbar">
    <div class="topbar__left">
      <span class="logo-mark">–ª–æ–≥–æ—Ç–∏–ø</span>
      <div class="title">
        <span class="title__text">–ú–ê–ô–°–ö–ê–Ø –ü–†–û–ì–£–õ–ö–ê</span>
      </div>
    </div>
    <div class="topbar__right">
      <div class="history-switcher">
        <button class="mode-btn" :disabled="undoStack.length < 2" @click="undoAction" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É">‚Ü©Ô∏è</button>
        <button class="mode-btn" :disabled="!redoStack.length" @click="redoAction" title="–í–µ—Ä–Ω—É—Ç—å —Ç–æ—á–∫—É">‚Ü™Ô∏è</button>
      </div>
      <div class="mode-switcher">
        <button class="mode-btn" :disabled="status === 'FINAL'" :class="{ active: mode === 'point' }" @click="setMode('point')" title="–¢–æ—á–µ—á–Ω—ã–π —Ä–µ–∂–∏–º">‚ö™Ô∏è</button>
        <button class="mode-btn" :disabled="status === 'FINAL'" :class="{ active: mode === 'free' }" @click="setMode('free')" title="–°–≤–æ–±–æ–¥–Ω—ã–π —Ä–µ–∂–∏–º">‚úèÔ∏è</button>
        <button class="mode-btn" :class="{ active: mode === 'pan' }" @click="setMode('pan')" title="–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã">ü§ö</button>
      </div>
      <div class="route-loader">
        <select class="input input--compact" v-model="selectedRouteId">
          <option disabled value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</option>
          <option v-for="route in routes" :key="route.id" :value="route.id">{{ route.name }}</option>
        </select>
        <button class="primary-btn" @click="openRoute">
          <i class="fa-solid fa-cloud-arrow-up"></i>
          –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
      </div>
    </div>
  </header>

  <div class="workspace">
    <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <aside class="sidebar">
      <section class="panel">
        <div class="panel__header">–ü—Ä–∏–≤—è–∑–∫–∞</div>
        <div class="panel__content">
          <label class="checkbox"><input type="checkbox" v-model="snapToRoads" disabled /> –ü–æ –¥–æ—Ä–æ–≥–∞–º</label>
          <label class="checkbox"><input type="checkbox" v-model="snapToArchive" /> –ö –∞—Ä—Ö–∏–≤—É</label>
        </div>
      </section>

      <section class="panel">
        <div class="panel__header">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
        <div class="panel__content">
          <label class="checkbox"><input type="checkbox" v-model="showOldRoutes" /> –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã</label>
        </div>
        <div class="tile-switcher">
          <button class="tile-btn" :class="{ active: tileLayer === 'osm' }" @click="setTile('osm')" title="OSM"><i class="fa-solid fa-earth-europe"></i></button>
          <button class="tile-btn" :class="{ active: tileLayer === 'arcgis' }" @click="setTile('arcgis')" title="ArcGIS"><i class="fa-regular fa-image"></i></button>
          <button class="tile-btn" :class="{ active: tileLayer === 'wikimapia' }" @click="setTile('wikimapia')" title="Wikimapia"><i class="fa-regular fa-map"></i></button>
          <button class="tile-btn" :class="{ active: tileLayer === 'google' }" @click="setTile('google')" title="Google"><i class="fa-brands fa-google"></i></button>
          <button class="tile-btn" :class="{ active: tileLayer === 'yandex' }" @click="setTile('yandex')" title="Yandex"><i class="fa-solid fa-location-dot"></i></button>
          <button class="tile-btn" :class="{ active: tileLayer === 'satellite' }" @click="setTile('satellite')" title="Satellite"><i class="fa-solid fa-satellite"></i></button>
        </div>
      </section>

      <section class="panel">
        <div class="panel__header">–°—Ç–∞—Ç—É—Å</div>
        <div class="panel__content">
          <select v-model="status" class="input">
            <option value="PRELIMINARY">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π</option>
            <option value="FINAL">–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π</option>
          </select>
        </div>
      </section>

      <section class="panel">
        <div class="panel__header">–ò–º—è –º–∞—Ä—à—Ä—É—Ç–∞</div>
        <div class="panel__content panel__content--stacked">
          <input v-if="status === 'PRELIMINARY'" v-model="routeName" class="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" />
          <div v-else class="route-name-display">{{ routeName }}</div>
        </div>
      </section>

      <section class="panel stats-card" :class="{ 'stats-card--final': status === 'FINAL' }">
        <div class="stat-line"><span class="stat-label">–ü—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å:</span> <span class="stat-value">{{ metrics?.totalKm || 0 }} –∫–º</span></div>
        <div class="stat-line"><span class="stat-label">–í—Ä–µ–º—è:</span> <span class="stat-value">{{ metrics?.estimatedMinutes || 0 }} –º–∏–Ω</span></div>
        <div class="stat-divider"></div>
        <div class="coverage-block" :class="{ 'coverage-block--highlight': status === 'FINAL' }">
          <div class="stat-heading">üìä –î–µ—Ç–∞–ª–∏ –ø–æ–∫—Ä—ã—Ç–∏—è:</div>
          <div class="stat-line">–ê—Å—Ñ–∞–ª—å—Ç: <span class="stat-value">{{ surfaceLabel('ASPHALT') }}</span></div>
          <div class="stat-line">–õ–µ—Å–Ω–∞—è —Ç—Ä–æ–ø–∞: <span class="stat-value">{{ surfaceLabel('FOREST_TRAIL') }}</span></div>
          <div class="stat-line">–ü–æ–ª–µ–≤–æ–π –ø—É—Ç—å: <span class="stat-value">{{ surfaceLabel('FIELD_PATH') }}</span></div>
          <div class="stat-line">–ñ/–î: <span class="stat-value">{{ surfaceLabel('RAILWAY') }}</span></div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-line">–ß–µ—Ä–Ω–æ–≤–∏–∫: <span class="stat-value">{{ metrics?.preliminaryKm || 0 }} –∫–º</span></div>
        <div class="stat-line">–û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π: <span class="stat-value">{{ metrics?.finalKm || 0 }} –∫–º</span></div>
      </section>

      <div class="panel actions">
        <button class="primary-btn" @click="saveRoute" :disabled="loading || status === 'PRELIMINARY'">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div class="export-group">
          <button class="secondary-btn" @click="exportRoute('gpx')" :disabled="status === 'PRELIMINARY'">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>

      <div class="notice" v-if="notice">{{ notice }}</div>
    </aside>

    <!-- –ö–ê–†–¢–ê -->
    <div id="map"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="js/app.js"></script>
</body>
</html>
